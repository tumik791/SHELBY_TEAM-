<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Выбор героя</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2b;
      --text:#e8eefc;
      --muted:#a7b3d6;
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #1b2a5a 0%, transparent 55%),
                  radial-gradient(1000px 600px at 80% 20%, #2a1b5a 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      width:min(1100px, 92vw);
      margin:0 auto;
      padding:24px 0 48px;
    }
    .screen{ display:none; }
    .screen.active{ display:block; }
    h1{ margin: 8px 0 10px; font-size: 28px; }
    p{ margin: 0 0 16px; color:var(--muted); line-height:1.45; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:14px;
      margin-top:18px;
    }
    .card{
      border:1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      min-height:220px;
      display:flex;
      flex-direction:column;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(122,162,255,0.45); }
    .thumb{
      height:150px;
      background-size: cover;
      background-position: center;
      background-color: rgba(255,255,255,0.03);
    }
    .card .body{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .name{ font-weight:700; }
    .small{ color:var(--muted); font-size:13px; }
    .result{
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:18px;
      margin-top:18px;
      align-items:start;
    }
    @media (max-width: 860px){
      .result{ grid-template-columns: 1fr; }
    }
    .panel{
      border:1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      padding:14px;
    }
    .result-img{
      width:100%;
      border-radius: calc(var(--radius) - 4px);
      border:1px solid rgba(255,255,255,0.08);
      display:block;
      background:#0d1324;
      user-select:none;
    }
    blockquote{
      margin:12px 0 0;
      padding:12px;
      border-left:3px solid rgba(122,162,255,0.8);
      background: rgba(0,0,0,0.18);
      border-radius: 10px;
      color: var(--text);
    }
    .meta{
      margin-top:10px;
      color: var(--muted);
      font-size: 13px;
      min-height: 18px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      transition: transform .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,0.5); }
    .btn.primary{ border-color: rgba(122,162,255,0.45); }
    .btn.danger{ border-color: rgba(255,107,107,0.5); }
    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size: 13px;
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.14);
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Экран выбора -->
    <section id="pickScreen" class="screen active">
      <h1>Выбери карточку</h1>
      <p>На iPhone звук часто запускается только по “живому” нажатию. Поэтому мы стартуем аудио прямо в клике по карточке, а также даём кнопку “Включить звук”.</p>
      <div class="grid" id="cardsGrid"></div>
      <div class="hint">Если звука нет: 1) проверь, что iPhone не в беззвучном режиме, 2) ссылка на аудио должна быть прямой <span class="badge">https://… .mp3</span> (без страниц/редиректов).</div>
    </section>

    <!-- Экран результата -->
    <section id="resultScreen" class="screen">
      <div class="row">
        <button class="btn" id="backBtn" type="button">← Назад</button>
        <button class="btn danger" id="stopBtn" type="button">Остановить звук</button>
      </div>

      <div class="result">
        <div class="panel">
          <img id="resultImage" class="result-img" alt="Результат" />
          <div class="hint">Если звук не включился — нажми на картинку или кнопку “Включить звук”.</div>
        </div>

        <div class="panel">
          <h2 id="resultTitle" style="margin:6px 0 8px;"></h2>
          <blockquote id="resultQuote"></blockquote>

          <div class="row">
            <button class="btn primary" id="soundBtn" type="button" style="display:none;">Включить звук</button>
          </div>

          <div id="resultMeta" class="meta"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ВАЖНО: теперь музыка ТОЛЬКО в hero3. В hero1/hero2 музыки нет.
    // musicUrl должен быть прямой ссылкой на файл (mp3/m4a) по https.
    const heroes = [
      {
        id: "hero1",
        name: "Герой 1",
        quote: "Цитата героя 1",
        cardImage: "https://picsum.photos/seed/hero1/600/400",
        resultImage: "https://picsum.photos/seed/hero1r/900/700",
        musicUrl: ""
      },
      {
        id: "hero2",
        name: "Герой 2",
        quote: "Цитата героя 2",
        cardImage: "https://picsum.photos/seed/hero2/600/400",
        resultImage: "https://picsum.photos/seed/hero2r/900/700",
        musicUrl: ""
      },
      {
        id: "hero3",
        name: "Герой 3 (с музыкой)",
        quote: "Цитата героя 3",
        cardImage: "https://picsum.photos/seed/hero3/600/400",
        resultImage: "https://picsum.photos/seed/hero3r/900/700",
        musicUrl: "https://rus.hitmotop.com/get/music/20230706/3_-_Zvuki_stonaZvuki_devushki_zvuki_krikovMEM_bassboost_reverb_76290123.mp3"
      }
    ];

    // DOM
    const pickScreen = document.getElementById("pickScreen");
    const resultScreen = document.getElementById("resultScreen");
    const cardsGrid = document.getElementById("cardsGrid");

    const resultTitle = document.getElementById("resultTitle");
    const resultQuote = document.getElementById("resultQuote");
    const resultImage = document.getElementById("resultImage");
    const resultMeta = document.getElementById("resultMeta");

    const backBtn = document.getElementById("backBtn");
    const stopBtn = document.getElementById("stopBtn");
    const soundBtn = document.getElementById("soundBtn");

    // Audio: один общий объект
    const heroAudio = new Audio();
    heroAudio.preload = "none";
    heroAudio.playsInline = true;

    let currentHero = null;

    function setMeta(text) {
      resultMeta.textContent = text || "";
    }

    function stopAudio() {
      try {
        heroAudio.pause();
        heroAudio.currentTime = 0;
        heroAudio.removeAttribute("src");
      } catch (e) {}
    }

    function playHeroAudio(hero) {
      if (!hero || !hero.musicUrl) {
        setMeta("У этого героя нет музыки.");
        return;
      }

      try {
        heroAudio.pause();
        heroAudio.currentTime = 0;
      } catch (e) {}

      heroAudio.muted = false;
      heroAudio.volume = 1;
      heroAudio.src = hero.musicUrl;

      const p = heroAudio.play();
      if (p && typeof p.then === "function") {
        p.then(() => setMeta("Звук включён."))
         .catch((err) => {
           console.log("Audio play blocked:", err);
           setMeta("Звук заблокирован браузером. Нажми «Включить звук» или по картинке результата.");
         });
      } else {
        setMeta("Попытка включить звук выполнена.");
      }
    }

    function showPick() {
      resultScreen.classList.remove("active");
      pickScreen.classList.add("active");
      setMeta("");
    }

    function showResult(hero) {
      currentHero = hero;

      pickScreen.classList.remove("active");
      resultScreen.classList.add("active");

      resultTitle.textContent = hero.name;
      resultQuote.textContent = hero.quote || "";
      resultImage.src = hero.resultImage || hero.cardImage || "";
      resultImage.alt = `Результат: ${hero.name}`;

      soundBtn.style.display = hero.musicUrl ? "inline-block" : "none";

      if (hero.musicUrl) {
        setMeta("Если звука нет — нажми «Включить звук» (или по картинке).");
      } else {
        setMeta("Музыка не задана.");
      }

      const url = new URL(window.location.href);
      url.searchParams.set("hero", hero.id);
      history.replaceState(null, "", url.toString());
    }

    function createCard(hero) {
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.style.backgroundImage = hero.cardImage ? `url("${hero.cardImage}")` : "none";

      const body = document.createElement("div");
      body.className = "body";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = hero.name;

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = hero.musicUrl ? "Есть музыка" : "Без музыки";

      body.appendChild(name);
      body.appendChild(small);

      card.appendChild(thumb);
      card.appendChild(body);

      card.addEventListener("click", () => {
        stopAudio();
        if (hero.musicUrl) playHeroAudio(hero);
        showResult(hero);
      });

      return card;
    }

    function renderCards() {
      cardsGrid.innerHTML = "";
      heroes.forEach((hero) => cardsGrid.appendChild(createCard(hero)));
    }

    soundBtn.addEventListener("click", () => {
      stopAudio();
      if (currentHero) playHeroAudio(currentHero);
    });

    resultImage.addEventListener("click", () => {
      stopAudio();
      if (currentHero) playHeroAudio(currentHero);
    });

    backBtn.addEventListener("click", () => {
      stopAudio();
      showPick();

      const url = new URL(window.location.href);
      url.searchParams.delete("hero");
      history.replaceState(null, "", url.toString());
    });

    stopBtn.addEventListener("click", () => {
      stopAudio();
      setMeta("Звук остановлен.");
    });

    heroAudio.addEventListener("ended", () => setMeta("Трек закончился."));

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopAudio();
    });

    function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const heroId = params.get("hero");
      if (!heroId) return;

      const hero = heroes.find((h) => h.id === heroId);
      if (hero) showResult(hero);
    }

    renderCards();
    initFromUrl();
  </script>
</body>
</html>
